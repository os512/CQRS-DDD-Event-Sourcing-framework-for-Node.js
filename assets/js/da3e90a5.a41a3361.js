"use strict";(self.webpackChunkwebsite=self.webpackChunkwebsite||[]).push([[9574],{6149:(e,t,r)=>{r.r(t),r.d(t,{frontMatter:()=>p,contentTitle:()=>i,metadata:()=>m,toc:()=>c,default:()=>d});var n=r(2685),a=r(1244),o=(r(7378),r(5318)),l=["components"],p={id:"export-import",title:"Event Export and Import"},i=void 0,m={unversionedId:"export-import",id:"export-import",title:"Event Export and Import",description:"Export/Import API",source:"@site/../docs/export-import.md",sourceDirName:".",slug:"/export-import",permalink:"/resolve/docs/export-import",tags:[],version:"current",frontMatter:{id:"export-import",title:"Event Export and Import"},sidebar:"docs",previous:{title:"File Upload",permalink:"/resolve/docs/file-upload"},next:{title:"Preparing for Production",permalink:"/resolve/docs/preparing-for-production"}},c=[{value:"Export/Import API",id:"exportimport-api",children:[{value:"Example",id:"example",children:[],level:3}],level:2},{value:"Incremental import",id:"incremental-import",children:[{value:"Basic Incremental Import",id:"basic-incremental-import",children:[{value:"Example API handler",id:"example-api-handler",children:[],level:4}],level:3},{value:"Advanced Incremental import",id:"advanced-incremental-import",children:[{value:"Example",id:"example-1",children:[],level:4}],level:3}],level:2}],s={toc:c};function d(e){var t=e.components,r=(0,a.Z)(e,l);return(0,o.kt)("wrapper",(0,n.Z)({},s,r,{components:t,mdxType:"MDXLayout"}),(0,o.kt)("h2",{id:"exportimport-api"},"Export/Import API"),(0,o.kt)("p",null,"Each event store adapter exposes the following API used for event export and import:"),(0,o.kt)("table",null,(0,o.kt)("thead",{parentName:"table"},(0,o.kt)("tr",{parentName:"thead"},(0,o.kt)("th",{parentName:"tr",align:null},"Method"),(0,o.kt)("th",{parentName:"tr",align:null},"Description"))),(0,o.kt)("tbody",{parentName:"table"},(0,o.kt)("tr",{parentName:"tbody"},(0,o.kt)("td",{parentName:"tr",align:null},"export"),(0,o.kt)("td",{parentName:"tr",align:null},"Returns a readable stream used to export events from an event store.")),(0,o.kt)("tr",{parentName:"tbody"},(0,o.kt)("td",{parentName:"tr",align:null},"import"),(0,o.kt)("td",{parentName:"tr",align:null},"Returns a writeable stream used to import events into an event store.")))),(0,o.kt)("p",null,"In the code sample below, a readable stream returned by an event store's ",(0,o.kt)("inlineCode",{parentName:"p"},"export")," method is pipelined directly into a writable stream returned by a recipient event store's ",(0,o.kt)("inlineCode",{parentName:"p"},"import")," method."),(0,o.kt)("h3",{id:"example"},"Example"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-js"},"import { Readable, pipeline as pipelineC } from 'stream'\n\nimport createEventStoreAdapter from '@resolve-js/eventstore-lite'\n\nconst pipeline = promisify(pipelineC)\n\nconst eventStore1 = createEventStoreAdapter({\n  databaseFile: './data/event-store-1.db',\n})\n\nconst eventStore2 = createEventStoreAdapter({\n  databaseFile: './data/event-store-2.db',\n})\n\nawait pipeline(eventStore1.export(), eventStore2.import())\n")),(0,o.kt)("h2",{id:"incremental-import"},"Incremental import"),(0,o.kt)("p",null,"Incremental import allows you to import into an event store only those events that do not already exist in this event store. Incremental import also skips events that are older (i.e., have an older timestamp) than the latest event in the recipient event store."),(0,o.kt)("h3",{id:"basic-incremental-import"},"Basic Incremental Import"),(0,o.kt)("p",null,"To import events incrementally, pass an array of events to an event store adapter's ",(0,o.kt)("a",{parentName:"p",href:"/resolve/docs/api/event-store-adapter#incrementalimport"},"incrementalImport")," method."),(0,o.kt)("p",null,"The code sample below implements an API endpoint that incrementally imports events into the application's event store."),(0,o.kt)("h4",{id:"example-api-handler"},"Example API handler"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-js"},"import iconv from 'iconv-lite'\n\nasync function handler(req, res) {\n  const bodyCharset = (\n    bodyOptions.find((option) => option.startsWith('charset=')) ||\n    'charset=utf-8'\n  ).substring(8)\n\n  if (bodyCharset !== 'utf-8') {\n    bodyContent = iconv.decode(iconv.encode(bodyContent, 'utf-8'), bodyCharset)\n  }\n\n  const events = JSON.parse(body)\n\n  await req.resolve.eventstoreAdapter.incrementalImport(events)\n}\n\nexport default handler\n")),(0,o.kt)("h3",{id:"advanced-incremental-import"},"Advanced Incremental import"),(0,o.kt)("p",null,"The following methods give you additional control over the incremental import process:"),(0,o.kt)("table",null,(0,o.kt)("thead",{parentName:"table"},(0,o.kt)("tr",{parentName:"thead"},(0,o.kt)("th",{parentName:"tr",align:null},"Method"),(0,o.kt)("th",{parentName:"tr",align:null},"Description"))),(0,o.kt)("tbody",{parentName:"table"},(0,o.kt)("tr",{parentName:"tbody"},(0,o.kt)("td",{parentName:"tr",align:null},(0,o.kt)("a",{parentName:"td",href:"/resolve/docs/api/event-store-adapter#beginincrementalimport"},"beginIncrementalImport")),(0,o.kt)("td",{parentName:"tr",align:null},"Starts to accumulate events for incremental import.")),(0,o.kt)("tr",{parentName:"tbody"},(0,o.kt)("td",{parentName:"tr",align:null},(0,o.kt)("a",{parentName:"td",href:"/resolve/docs/api/event-store-adapter#pushincrementalimport"},"pushIncrementalImport")),(0,o.kt)("td",{parentName:"tr",align:null},"Accumulates events for incremental import.")),(0,o.kt)("tr",{parentName:"tbody"},(0,o.kt)("td",{parentName:"tr",align:null},(0,o.kt)("a",{parentName:"td",href:"/resolve/docs/api/event-store-adapter#commitincrementalimport"},"commitIncrementalImport")),(0,o.kt)("td",{parentName:"tr",align:null},"Commits the accumulated events to the event store.")),(0,o.kt)("tr",{parentName:"tbody"},(0,o.kt)("td",{parentName:"tr",align:null},(0,o.kt)("a",{parentName:"td",href:"/resolve/docs/api/event-store-adapter#rollbackincrementaiImport"},"rollbackIncrementalImport")),(0,o.kt)("td",{parentName:"tr",align:null},"Drops the accumulated events.")))),(0,o.kt)("p",null,"The code sample below demonstrates how to use advanced incremental import in a try-catch block to roll back in case of errors."),(0,o.kt)("h4",{id:"example-1"},"Example"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-js"},"try {\n  const importId = await eventStoreAdapter.beginIncrementalImport()\n  await eventStoreAdapter.pushIncrementalImport(events, importId)\n  await eventStoreAdapter.commitIncrementalImport(importId)\n} catch (error) {\n  await eventStoreAdapter.rollbackIncrementalImport()\n  throw error\n}\n")))}d.isMDXComponent=!0},5318:(e,t,r)=>{r.d(t,{Zo:()=>c,kt:()=>u});var n=r(7378);function a(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function o(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,n)}return r}function l(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?o(Object(r),!0).forEach((function(t){a(e,t,r[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):o(Object(r)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))}))}return e}function p(e,t){if(null==e)return{};var r,n,a=function(e,t){if(null==e)return{};var r,n,a={},o=Object.keys(e);for(n=0;n<o.length;n++)r=o[n],t.indexOf(r)>=0||(a[r]=e[r]);return a}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(n=0;n<o.length;n++)r=o[n],t.indexOf(r)>=0||Object.prototype.propertyIsEnumerable.call(e,r)&&(a[r]=e[r])}return a}var i=n.createContext({}),m=function(e){var t=n.useContext(i),r=t;return e&&(r="function"==typeof e?e(t):l(l({},t),e)),r},c=function(e){var t=m(e.components);return n.createElement(i.Provider,{value:t},e.children)},s={inlineCode:"code",wrapper:function(e){var t=e.children;return n.createElement(n.Fragment,{},t)}},d=n.forwardRef((function(e,t){var r=e.components,a=e.mdxType,o=e.originalType,i=e.parentName,c=p(e,["components","mdxType","originalType","parentName"]),d=m(r),u=a,v=d["".concat(i,".").concat(u)]||d[u]||s[u]||o;return r?n.createElement(v,l(l({ref:t},c),{},{components:r})):n.createElement(v,l({ref:t},c))}));function u(e,t){var r=arguments,a=t&&t.mdxType;if("string"==typeof e||a){var o=r.length,l=new Array(o);l[0]=d;var p={};for(var i in t)hasOwnProperty.call(t,i)&&(p[i]=t[i]);p.originalType=e,p.mdxType="string"==typeof e?e:a,l[1]=p;for(var m=2;m<o;m++)l[m]=r[m];return n.createElement.apply(null,l)}return n.createElement.apply(null,r)}d.displayName="MDXCreateElement"}}]);